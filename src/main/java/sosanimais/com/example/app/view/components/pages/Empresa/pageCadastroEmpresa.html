<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Amigos de Animais - Cadastro da Empresa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-orange-burnt: #d37a47;
            --color-brown-dark: #4a2d21;
            --color-beige-light: #f2e6db;
            --color-orange-light: #e59a62;
            --color-orange-burnt-hover: #c06b3a;
            --color-orange-burnt-active: #b05d2c;
            --text-light: #ffffff;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--color-beige-light);
            color: var(--color-brown-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar-brand-custom {
            color: var(--text-light);
            font-weight: bold;
            font-size: 1.5rem;
        }
        .navbar-brand-custom img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            filter: brightness(0) invert(1);
        }
        .header-custom {
            background-color: var(--color-orange-burnt-active);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-custom .nav-link, .header-custom .navbar-toggler-icon {
            color: var(--text-light) !important;
        }
         .header-custom .navbar-toggler {
            border-color: rgba(255,255,255,0.3);
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100; 
            padding: 56px 0 0; 
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: var(--color-orange-burnt);
            width: 250px;
        }
        .sidebar.collapse:not(.show) {
            width: 0;
            padding-left: 0;
            padding-right: 0;
        }
        @media (min-width: 768px) {
           .sidebar {
                padding-top: 56px;
           }
           .main-content-area {
                padding-left: 250px;
           }
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: var(--text-light);
            padding: 0.75rem 1.25rem;
        }
        .sidebar .nav-link .fa-fw {
            width: 1.2em; 
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: var(--text-light);
            background-color: var(--color-orange-burnt-hover);
        }
        .sidebar .nav-item .collapse .nav-link, .sidebar .nav-item .collapsing .nav-link {
            padding-left: 2.5rem;
        }
        .main-content-area {
             padding-top: 70px; 
        }
        .page-title {
            color: var(--color-brown-dark);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        .page-title i {
            margin-right: 0.5rem;
            color: var(--color-orange-burnt);
        }
        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(74, 45, 33, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .form-container .form-label {
            font-weight: bold;
            color: var(--color-brown-dark);
        }
        .form-control:focus {
            border-color: var(--color-orange-burnt);
            box-shadow: 0 0 0 0.25rem rgba(211, 122, 71, 0.25);
        }
        .btn-primary-custom {
            background-color: var(--color-orange-burnt);
            border-color: var(--color-orange-burnt);
            color: var(--text-light);
        }
        .btn-primary-custom:hover {
            background-color: var(--color-orange-burnt-hover);
            border-color: var(--color-orange-burnt-hover);
        }
        .btn-secondary-custom {
            background-color: transparent;
            border: 1px solid var(--color-orange-burnt);
            color: var(--color-orange-burnt);
        }
        .btn-secondary-custom:hover {
            background-color: rgba(211, 122, 71, 0.1);
        }
        .footer-custom {
            background-color: var(--color-orange-burnt-active);
            color: var(--text-light);
            padding: 1rem 0;
            font-size: 0.9rem;
            margin-top: auto;
        }
         @media (min-width: 768px) {
            .footer-custom {
                 padding-left: 250px;
            }
        }
        .footer-custom a {
            color: var(--text-light);
            text-decoration: none;
        }
        .footer-custom a:hover {
            text-decoration: underline;
        }
        .toast-container {
            z-index: 1090; 
        }
        .paw-logo-footer {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            filter: brightness(0) invert(1);
        }
        body.sidebar-open .main-content-area {
            margin-left: 250px;
        }
    </style>
</head>
<body>

    <header class="navbar navbar-expand-md navbar-dark fixed-top header-custom px-3">
        <a class="navbar-brand-custom" href="home.html">
            <img src="./assets/images/paw-logo.png" alt="Logo SOS Amigos de Animais"> SOS Amigos de Animais
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Alternar navegação">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto flex-row">
                <li class="nav-item me-3">
                    <a class="nav-link" href="#" title="Notificações">
                        <i class="fas fa-bell fa-lg"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" title="Perfil">
                        <i class="fas fa-user-circle fa-lg"></i>
                    </a>
                </li>
            </ul>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="home.html">
                                <i class="fas fa-home fa-fw"></i> Dashboard
                            </a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#empresaSubmenu" data-bs-toggle="collapse" aria-expanded="true">
                                <i class="fas fa-building fa-fw"></i> Empresa
                            </a>
                            <ul class="collapse list-unstyled show" id="empresaSubmenu">
                                <li><a class="nav-link ps-4 active" href="pageCadastroEmpresa.html"><i class="fas fa-plus-circle fa-fw"></i> Cadastrar</a></li>
                                <li><a class="nav-link ps-4" href="pageSobre.html"><i class="fas fa-info-circle fa-fw"></i> Sobre</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#animalSubmenu" data-bs-toggle="collapse" aria-expanded="false">
                                <i class="fas fa-paw fa-fw"></i> Animais
                            </a>
                            <ul class="collapse list-unstyled" id="animalSubmenu">
                                <li><a class="nav-link ps-4" href="#"><i class="fas fa-list fa-fw"></i> Listar</a></li>
                                <li><a class="nav-link ps-4" href="#"><i class="fas fa-plus fa-fw"></i> Cadastrar</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-box-open fa-fw"></i> Produtos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-users fa-fw"></i> Pessoas
                            </a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-hand-holding-heart fa-fw"></i> Doações
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-cog fa-fw"></i> Configurações
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content-area">
                <h1 class="page-title mt-3"><i class="fas fa-building"></i> Cadastro da Empresa</h1>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i> Esta é a página para o cadastro inicial da sua organização. As informações aqui inseridas serão utilizadas em todo o sistema.
                </div>

                <div class="form-container">
                    <form id="empresaForm" novalidate>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="emp-nome" class="form-label">Nome da Empresa <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="emp-nome" name="nome" required>
                                <div class="invalid-feedback">Por favor, informe o nome da empresa.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="emp-nome-fantasia" class="form-label">Nome Fantasia</label>
                                <input type="text" class="form-control" id="emp-nome-fantasia" name="nomeFantasia">
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="emp-cnpj" class="form-label">CNPJ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="emp-cnpj" name="cnpj" required placeholder="XX.XXX.XXX/XXXX-XX">
                                <div class="invalid-feedback">CNPJ inválido. Utilize o formato XX.XXX.XXX/XXXX-XX.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="emp-telefone" class="form-label">Telefone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="emp-telefone" name="telefone" required placeholder="(XX) XXXXX-XXXX">
                                <div class="invalid-feedback">Telefone inválido. Utilize o formato (XX) XXXXX-XXXX.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="emp-capacidade" class="form-label">Capacidade de Acolhimento <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="emp-capacidade" name="capacidade" required min="0">
                            <div class="invalid-feedback">Informe a capacidade (número igual ou maior que zero).</div>
                        </div>

                        <hr class="my-4">
                        <h5 class="mb-3">Endereço</h5>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="emp-cep" class="form-label">CEP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="emp-cep" name="cep" required placeholder="XXXXX-XXX">
                                <div class="invalid-feedback">CEP inválido. Utilize o formato XXXXX-XXX.</div>
                            </div>
                             <div class="col-md-2">
                                <button type="button" class="btn btn-outline-secondary mt-4 w-100" id="btnBuscarCep" onclick="buscarEnderecoPorCep()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                             <div class="col-md-6">
                                <label for="emp-rua" class="form-label">Rua <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="emp-rua" name="rua" required>
                                 <div class="invalid-feedback">Informe a rua.</div>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="emp-numero" class="form-label">Número <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="emp-numero" name="numero" required>
                                <div class="invalid-feedback">Informe o número.</div>
                            </div>
                            <div class="col-md-8">
                                <label for="emp-bairro" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="emp-bairro" name="bairro">
                            </div>
                        </div>
                         <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="emp-cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="emp-cidade" name="cidade">
                            </div>
                            <div class="col-md-6">
                                <label for="emp-estado" class="form-label">Estado (UF)</label>
                                <input type="text" class="form-control" id="emp-estado" name="estado" maxlength="2">
                            </div>
                        </div>
                        
                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="emp-descricao" class="form-label">Descrição da Empresa/ONG</label>
                            <textarea class="form-control" id="emp-descricao" name="descricao" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="emp-historia" class="form-label">História da Empresa/ONG</label>
                            <textarea class="form-control" id="emp-historia" name="historia" rows="4"></textarea>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary-custom btn-lg"><i class="fas fa-save"></i> Salvar Cadastro da Empresa</button>
                            <button type="reset" class="btn btn-secondary-custom btn-lg"><i class="fas fa-times"></i> Limpar</button>
                        </div>
                    </form>
                </div>

                <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3">
                </div>
            </main>
        </div>
    </div>

    <footer class="footer-custom mt-auto text-center text-md-start">
        <div class="container">
             <div class="row align-items-center">
                <div class="col-md-4 text-center text-md-start mb-2 mb-md-0">
                    <img src="./assets/images/paw-logo.png" alt="Logo SOS Amigos de Animais Rodapé" class="paw-logo-footer">
                    <span>SOS Amigos de Animais</span>
                </div>
                <div class="col-md-4 text-center mb-2 mb-md-0">
                    &copy; 2024 Todos os direitos reservados.
                </div>
                <div class="col-md-4 text-center text-md-end">
                    <a href="#" class="me-3">Privacidade</a>
                    <a href="#">Termos</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        function showToast(type, title, message, autohide = true, delay = 5000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
            const toastTypeClass = type === 'error' ? 'danger' : (type === 'info' ? 'primary' : type);
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-bg-${toastTypeClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}" data-bs-autohide="${autohide}">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toastInstance = new bootstrap.Toast(toastElement);
            toastInstance.show();
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        function applyMask(inputElement, maskFunction) {
            inputElement.addEventListener('input', function(e) {
                e.target.value = maskFunction(e.target.value);
            });
        }

        applyMask(document.getElementById('emp-cnpj'), function(value) {
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
            return value.substring(0, 18);
        });

        applyMask(document.getElementById('emp-telefone'), function(value) {
            value = value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0,11);
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 6) {
                 value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                 value = value.replace(/^(\d{2})(\d*)/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d*)/, '($1');
            }
            return value;
        });
        
        applyMask(document.getElementById('emp-cep'), function(value) {
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            return value.substring(0, 9);
        });
        
        async function buscarEnderecoPorCep() {
            const cepInput = document.getElementById('emp-cep');
            const ruaInput = document.getElementById('emp-rua');
            const bairroInput = document.getElementById('emp-bairro');
            const cidadeInput = document.getElementById('emp-cidade');
            const estadoInput = document.getElementById('emp-estado');
            const cep = cepInput.value.replace(/\D/g, '');

            if (cep.length !== 8) {
                showToast('info', 'CEP Inválido', 'Por favor, digite um CEP com 8 dígitos.');
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) {
                    throw new Error('Não foi possível buscar o CEP.');
                }
                const data = await response.json();
                if (data.erro) {
                    showToast('error', 'CEP Não Encontrado', 'Verifique o CEP digitado.');
                } else {
                    ruaInput.value = data.logradouro || '';
                    bairroInput.value = data.bairro || '';
                    cidadeInput.value = data.localidade || '';
                    estadoInput.value = data.uf || '';
                    showToast('success', 'CEP Encontrado!', 'Endereço preenchido.');
                    document.getElementById('emp-numero').focus();
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                showToast('error', 'Erro ao Buscar CEP', error.message);
            }
        }

        document.getElementById('empresaForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            event.stopPropagation();

            const form = event.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showToast('error', 'Campos Inválidos', 'Por favor, preencha todos os campos obrigatórios corretamente.');
                return;
            }
            form.classList.add('was-validated');

            const empresaData = {
                nome: document.getElementById('emp-nome').value,
                nomeFantasia: document.getElementById('emp-nome-fantasia').value || null,
                cnpj: document.getElementById('emp-cnpj').value.replace(/\D/g, ''),
                telefone: document.getElementById('emp-telefone').value.replace(/\D/g, ''),
                capacidade: parseInt(document.getElementById('emp-capacidade').value),
                descricao: document.getElementById('emp-descricao').value || null,
                historia: document.getElementById('emp-historia').value || null,
                endereco: {
                    rua: document.getElementById('emp-rua').value,
                    cep: document.getElementById('emp-cep').value.replace(/\D/g, ''),
                    numero: document.getElementById('emp-numero').value,
                    bairro: document.getElementById('emp-bairro').value || null,
                    cidade: document.getElementById('emp-cidade').value || null,
                    estado: document.getElementById('emp-estado').value || null
                }
            };

            const API_ENDPOINT = '/apis/empresa/cadastro';
            const TOKEN = 'Bearer SEU_TOKEN_AQUI'; 

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(empresaData)
                });

                if (response.ok) {
                    await response.json();
                    showToast('success', 'Cadastro Realizado!', 'A empresa foi cadastrada com sucesso. Você será redirecionado.');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 3000);
                } else {
                    const errorData = await response.json().catch(() => ({ message: `Erro ${response.status} ao salvar empresa.` }));
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('Erro ao cadastrar empresa:', error);
                showToast('error', 'Falha no Cadastro', error.message || 'Não foi possível conectar ao servidor.');
            }
        });
    </script>
</body>
</html>